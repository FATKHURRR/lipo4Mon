<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPT Solar Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c); padding: 20px; color: #333; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); overflow: hidden; padding: 25px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 3px solid #3498db; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .header h2 { color: #3498db; font-size: 1.3rem; font-weight: normal; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(to right, #2c3e50, #34495e); color: white; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .connection-status { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #e74c3c; animation: pulse 2s infinite; }
        .status-dot.connected { background: #2ecc71; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .device-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; padding: 15px; background: linear-gradient(to bottom right, #f8f9fa, #e9ecef); border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .device-info div { background: white; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: transform 0.3s ease; }
        .device-info div:hover { transform: translateY(-3px); }
        .device-info strong { color: #2c3e50; font-size: 0.9rem; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: linear-gradient(to bottom right, #ffffff, #f8f9fa); padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
        .card h2 { font-size: 1.4rem; margin-bottom: 20px; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #ecf0f1; }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: #7f8c8d; font-size: 1rem; }
        .metric-value { font-weight: bold; font-size: 1.3rem; color: #2c3e50; }
        .metric-value.large { font-size: 2rem; color: #e74c3c; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: #2ecc71; box-shadow: 0 0 10px rgba(46,204,113,0.5); }
        .status-error { background: #e74c3c; box-shadow: 0 0 10px rgba(231,76,60,0.5); }
        .alert-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9rem; }
        .alert-item { padding: 10px 15px; border-radius: 8px; background: white; border-left: 4px solid #95a5a6; box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; }
        .alert-item:hover { transform: translateX(5px); }
        .alert-item.active { background: linear-gradient(to right, #e74c3c, #c0392b); color: white; font-weight: bold; border-left: 4px solid #c0392b; animation: alertPulse 1.5s infinite; }
        @keyframes alertPulse { 0%, 100% { box-shadow: 0 3px 8px rgba(231,76,60,0.3); } 50% { box-shadow: 0 5px 15px rgba(231,76,60,0.6); } }
        .chart-container { background: linear-gradient(to bottom right, #ffffff, #f8f9fa); padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-top: 20px; }
        .chart-container h2 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .chart-wrapper { position: relative; height: 400px; width: 100%; }
        .date-selector { margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .date-selector label { font-weight: 600; color: #2c3e50; }
        .date-selector input { padding: 12px 15px; border: 2px solid #3498db; border-radius: 8px; font-size: 1rem; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .date-selector input:focus { outline: none; border-color: #2980b9; box-shadow: 0 4px 10px rgba(52,152,219,0.2); }
        .date-selector button { padding: 12px 25px; background: linear-gradient(to right, #3498db, #2c3e50); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .date-selector button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); background: linear-gradient(to right, #2c3e50, #3498db); }
        .date-selector button:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        .sensors { display: flex; flex-wrap: wrap; gap: 12px; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px; }
        .sensor-item { display: flex; align-items: center; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer; }
        .sensor-item:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.12); }
        .sensor-item input[type="checkbox"] { margin-right: 8px; cursor: pointer; width: 18px; height: 18px; }
        .sensor-item label { cursor: pointer; font-weight: 500; font-size: 0.9rem; user-select: none; }
        .log-status { padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #27ae60; text-align: center; margin-top: 10px; }
        @media (max-width: 768px) { body { padding: 10px; } .container { padding: 15px; } .header h1 { font-size: 2rem; } .status-grid { grid-template-columns: 1fr; } .device-info { grid-template-columns: 1fr; } .date-selector { flex-direction: column; } .date-selector input, .date-selector button { width: 100%; } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } ::-webkit-scrollbar-thumb { background: #3498db; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MPPT Solar Monitoring</h1>
            <h2>Real-time via MQTT</h2>
        </div>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connStatus">Connecting...</span>
            </div>
            <div>Last Update: <span id="lastUpdate">-</span></div>
        </div>

        <div class="device-info">
            <div><strong>Uptime:</strong> <span id="uptime">-</span></div>
            <div><strong>Heap:</strong> <span id="heap">-</span> bytes</div>
            <div><strong>WiFi:</strong> <span id="wifi">-</span></div>
            <div><strong>IP:</strong> <span id="ip">-</span></div>
            <div><strong>Time:</strong> <span id="datetime">-</span></div>
        </div>

        <div class="status-grid">
            <div class="card">
                <h2>Battery</h2>
                <div class="metric"><span class="metric-label">Voltage</span><span class="metric-value large" id="voltBat">-- V</span></div>
                <div class="metric"><span class="metric-label">Current</span><span class="metric-value" id="current">-- A</span></div>
                <div class="metric"><span class="metric-label">Power</span><span class="metric-value" id="power">-- W</span></div>
                <div class="metric"><span class="metric-label">Peak Power</span><span class="metric-value" id="peakPower">-- W</span></div>
            </div>
            <div class="card">
                <h2>Solar</h2>
                <div class="metric"><span class="metric-label">PV Voltage</span><span class="metric-value large" id="voltPv">-- V</span></div>
                <div class="metric"><span class="metric-label">Today Energy</span><span class="metric-value" id="todayEnergy">-- kWh</span></div>
                <div class="metric"><span class="metric-label">Total Energy</span><span class="metric-value" id="totalEnergy">-- kWh</span></div>
                <div class="metric"><span class="metric-label">Load %</span><span class="metric-value" id="loadPercent">-- %</span></div>
            </div>
            <div class="card">
                <h2>Temperature</h2>
                <div class="metric"><span class="metric-label">Environment</span><span class="metric-value" id="tempEnvi">-- °C</span></div>
                <div class="metric"><span class="metric-label">Heatsink</span><span class="metric-value" id="tempMppt">-- °C</span></div>
                <div class="metric"><span class="metric-label">Status Code</span><span class="metric-value" id="statusCode">--</span></div>
            </div>
            <div class="card">
                <h2>Status</h2>
                <div class="metric"><span class="metric-label">Load Out</span><span id="statusLoadOut">-</span></div>
                <div class="metric"><span class="metric-label">Charging</span><span id="statusCharging">-</span></div>
                <div class="metric"><span class="metric-label">Bat Full</span><span id="statusBatFull">-</span></div>
                <div class="metric"><span class="metric-label">Warning</span><span id="statusWarn">-</span></div>
                <div class="metric"><span class="metric-label">Fault</span><span id="statusFault">-</span></div>
            </div>
        </div>

        <div class="card"><h2>Alarms</h2><div class="alert-grid" id="alarmGrid"></div></div>
        <div class="card" style="margin-top: 20px;"><h2>Faults</h2><div class="alert-grid" id="faultGrid"></div></div>

        <div class="chart-container">
            <h2>Historical Data</h2>
            <div class="date-selector">
                <label>Date:</label>
                <input type="date" id="chartDate">
                <button id="loadBtn" onclick="requestLogData()">Load</button>
            </div>
            <div class="log-status" id="logStatus"></div>
            <div class="sensors" id="checkboxContainer"></div>
            <div class="chart-wrapper"><canvas id="historyChart"></canvas></div>
            <div class="zoom-instructions">Tip: Scroll to zoom, Shift + drag to pan</div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        let chart = null;
        let datasets = [];
        let client = null;
        let deviceId = null;

        // === Log Streaming State ===
        let isCollectingLog = false;
        let logBuffer = "";
        const START_MARKER = ">>> START LOG <<<";
        const END_MARKER = ">>> END LOG <<<";

        // === Get Device ID ===
        function getDeviceId() {
            const params = new URLSearchParams(location.search);
            let id = params.get('id');
            if (id) return id.trim();
            id = prompt("Masukkan ID MPPT (contoh: MPPT001):");
            if (!id?.trim()) { alert("ID wajib diisi!"); return null; }
            const url = new URL(location);
            url.searchParams.set('id', id.trim());
            history.replaceState({}, '', url);
            return id.trim();
        }

        // === Format Uptime ===
        function formatUptime(s) {
            const d = Math.floor(s / 86400);
            const h = Math.floor((s % 86400) / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${d}d ${h}h ${m}m ${s % 60}s`;
        }

        // === Status Dot ===
        function statusDot(active) {
            return `<span class="status-indicator ${active ? 'status-error' : 'status-ok'}"></span>${active ? 'ACTIVE' : 'OFF'}`;
        }

        // === Update Time ===
        function updateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // === Update UI ===
        function updateUI(json) {
            const d = json.data, dev = json.device;
            document.getElementById('uptime').textContent = formatUptime(dev.uptime);
            document.getElementById('heap').textContent = dev.heap.toLocaleString();
            document.getElementById('wifi').textContent = dev.wifi;
            document.getElementById('ip').textContent = dev.ip;
            document.getElementById('datetime').textContent = `${d.year}-${String(d.month).padStart(2,'0')}-${String(d.date).padStart(2,'0')} ${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}:${String(d.second).padStart(2,'0')}`;
            document.getElementById('voltBat').textContent = d.volt_battery.toFixed(2) + ' V';
            document.getElementById('current').textContent = d.current.toFixed(2) + ' A';
            document.getElementById('power').textContent = d.power + ' W';
            document.getElementById('peakPower').textContent = d.peak_power + ' W';
            document.getElementById('voltPv').textContent = d.volt_pv.toFixed(1) + ' V';
            document.getElementById('todayEnergy').textContent = d.today_energy.toFixed(3) + ' kWh';
            document.getElementById('totalEnergy').textContent = d.total_energy.toFixed(1) + ' kWh';
            document.getElementById('loadPercent').textContent = d.load_percent + ' %';
            document.getElementById('tempEnvi').textContent = d.temp_envi + ' °C';
            document.getElementById('tempMppt').textContent = d.temp_mppt + ' °C';
            document.getElementById('statusCode').textContent = d.status_code;

            document.getElementById('statusLoadOut').innerHTML = statusDot(d.status.load_out);
            document.getElementById('statusCharging').innerHTML = statusDot(d.status.charging);
            document.getElementById('statusBatFull').innerHTML = statusDot(d.status.bat_full);
            document.getElementById('statusWarn').innerHTML = statusDot(d.status.warn);
            document.getElementById('statusFault').innerHTML = statusDot(d.status.fault);

            const alarmGrid = document.getElementById('alarmGrid'); alarmGrid.innerHTML = '';
            for (const [k, v] of Object.entries(d.alarm)) {
                const el = document.createElement('div');
                el.className = 'alert-item' + (v ? ' active' : '');
                el.textContent = k.replace(/_/g, ' ').toUpperCase();
                alarmGrid.appendChild(el);
            }
            const faultGrid = document.getElementById('faultGrid'); faultGrid.innerHTML = '';
            for (const [k, v] of Object.entries(d.fault)) {
                const el = document.createElement('div');
                el.className = 'alert-item' + (v ? ' active' : '');
                el.textContent = k.replace(/_/g, ' ').toUpperCase();
                faultGrid.appendChild(el);
            }
            updateTime();
        }

        // === Init MQTT ===
        function initMQTT() {
            deviceId = getDeviceId();
            if (!deviceId) return;

            const options = {
                clientId: 'web_' + Math.random().toString(16).slice(2, 10),
                username: 'public',
                password: 'public',
                keepalive: 60,
                reconnectPeriod: 1000,
                clean: true
            };

            client = mqtt.connect('wss://public.cloud.shiftr.io', options);

            client.on('connect', () => {
                console.log('MQTT Connected');
                client.subscribe(`mpptMon/${deviceId}/TX`, err => { if (err) console.error(err); });
                client.subscribe(`${deviceId}/TX/log`, err => { if (err) console.error(err); });
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connStatus').textContent = 'Connected';
            });

            client.on('message', (topic, message) => {
                const payload = message.toString();

                if (topic === `mpptMon/${deviceId}/TX`) {
                    try { updateUI(JSON.parse(payload)); } catch (e) { console.error('JSON Error:', e); }
                } 
                else if (topic === `${deviceId}/TX/log`) {
					console.log(payload);
                    handleLogChunk(payload);
                }
            });

            client.on('error', err => console.error('MQTT Error:', err));
            client.on('offline', () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('connStatus').textContent = 'Offline';
            });
        }

        // === Handle Log Chunk ===
        function handleLogChunk(chunk) {
            if (chunk.includes(START_MARKER)) {
                isCollectingLog = true;
                logBuffer = "";
                updateLogStatus("Menerima data log...");
                document.getElementById('loadBtn').disabled = true;
                console.log("Log transfer started");
                // Ambil bagian setelah marker
                const startIdx = chunk.indexOf(START_MARKER) + START_MARKER.length;
                if (chunk.length > startIdx) logBuffer += chunk.substring(startIdx);
                return;
            }

            if (!isCollectingLog) return;

            if (chunk.includes(END_MARKER)) {
                const endIdx = chunk.indexOf(END_MARKER);
                logBuffer += chunk.substring(0, endIdx);
                isCollectingLog = false;
                updateLogStatus("Log selesai. Rendering grafik...");
                setTimeout(() => {
                    renderChartFromCSV(logBuffer.trim());
                    updateLogStatus("Grafik siap!");
                    document.getElementById('loadBtn').disabled = false;
                }, 100);
                console.log("Log transfer completed");
                return;
            }

            // Kumpulkan chunk
            logBuffer += chunk;
            updateLogStatus(`Menerima data... (${(logBuffer.length/1024).toFixed(1)} KB)`);
        }

        function updateLogStatus(msg) {
            const el = document.getElementById('logStatus');
            el.textContent = msg;
            el.style.color = isCollectingLog ? '#e67e22' : '#27ae60';
        }

        // === Request Log ===
        function requestLogData() {
            if (!client?.connected) return alert('MQTT belum terhubung!');
            const date = document.getElementById('chartDate').value;
            if (!date) return alert('Pilih tanggal!');
            const [y, m, d] = date.split('-');
            const msg = `log log/${y}/${m}/${d}.csv`;
            client.publish(`${deviceId}/RX`, msg);
            console.log('Log requested:', msg);
            updateLogStatus("Menunggu data dari perangkat...");
        }

        // === Render Chart ===
        function renderChartFromCSV(csv) {
            const lines = csv.trim().split('\n').filter(l => l && !l.startsWith('#'));
            const data = { time: [], voltPv: [], voltBat: [], current: [], power: [], PeakPower: [], Day_Energy: [], Total_energy: [], percent_load: [], env_temp: [], heatSink_temp: [], status_code: [], RSSI: [] };

            lines.forEach(l => {
                const v = l.split(',');
                if (v.length >= 13) {
                    data.time.push(v[0]);
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(v[i]);
                        data[Object.keys(data)[i]].push(isNaN(val) ? 0 : val);
                    }
                }
            });

            const ctx = document.getElementById('historyChart').getContext('2d');
            if (chart) chart.destroy();

            datasets = [
                { label: 'PV Voltage (V)', data: data.voltPv, borderColor: '#e74c3c', hidden: false },
                { label: 'Battery Voltage (V)', data: data.voltBat, borderColor: '#3498db', hidden: false },
                { label: 'Current (A)', data: data.current, borderColor: '#2ecc71', hidden: false },
                { label: 'Power (W)', data: data.power, borderColor: '#f39c12', hidden: true },
                { label: 'Peak Power (W)', data: data.PeakPower, borderColor: '#e67e22', hidden: true },
                { label: 'Day Energy (kWh)', data: data.Day_Energy, borderColor: '#9b59b6', hidden: true },
                { label: 'Total Energy (kWh)', data: data.Total_energy, borderColor: '#8e44ad', hidden: true },
                { label: 'Load %', data: data.percent_load, borderColor: '#1abc9c', hidden: true },
                { label: 'Env Temp (°C)', data: data.env_temp, borderColor: '#16a085', hidden: true },
                { label: 'Heatsink Temp (°C)', data: data.heatSink_temp, borderColor: '#c0392b', hidden: true },
                { label: 'Status Code', data: data.status_code, borderColor: '#34495e', hidden: true },
                { label: 'RSSI (dBm)', data: data.RSSI, borderColor: '#7f8c8d', hidden: true }
            ].map(d => ({ ...d, backgroundColor: d.borderColor + '20', borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0 }));

            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: data.time, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Time' }, ticks: { maxTicksLimit: 12 } },
                        y: { title: { display: true, text: 'Value' } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    animation: { duration: 0 }
                }
            });
            createCheckboxes();
        }

        function createCheckboxes() {
            const c = document.getElementById('checkboxContainer'); c.innerHTML = '';
            datasets.forEach((d, i) => {
                const div = document.createElement('div'); div.className = 'sensor-item';
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !d.hidden; cb.id = `cb${i}`; cb.style.accentColor = d.borderColor;
                cb.onchange = () => { datasets[i].hidden = !cb.checked; chart.update(); };
                const lbl = document.createElement('label'); lbl.htmlFor = `cb${i}`; lbl.textContent = d.label; lbl.style.color = d.borderColor;
                div.append(cb, lbl); c.appendChild(div);
            });
        }

        // === INIT ===
        document.getElementById('chartDate').valueAsDate = new Date();
        initMQTT();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>