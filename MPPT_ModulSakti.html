<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPT Solar Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            padding: 10px; 
            color: #333; 
            min-height: 100vh; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.98); 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
            overflow: hidden; 
            padding: 15px; 
        }
        .header { 
            text-align: center; 
            padding: 20px 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .header h1 { 
            color: white; 
            font-size: clamp(1.5rem, 5vw, 2.5rem); 
            margin-bottom: 8px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header h1::before {
            content: '‚òÄÔ∏è';
            font-size: clamp(2rem, 6vw, 3rem);
        }
        .header h2 { 
            color: rgba(255,255,255,0.95); 
            font-size: clamp(0.9rem, 3vw, 1.2rem); 
            font-weight: 400;
            letter-spacing: 1px;
        }
        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px; 
            background: linear-gradient(135deg, #2c3e50, #3498db); 
            color: white; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
            flex-wrap: wrap;
            gap: 10px;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        .connection-status { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-weight: 600;
        }
        .status-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: #e74c3c; 
            animation: pulse 2s infinite; 
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
            flex-shrink: 0;
        }
        .status-dot.connected { 
            background: #2ecc71; 
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } }
        .device-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 10px; 
            padding: 15px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1); 
        }
        .device-info div { 
            background: white; 
            padding: 10px 12px; 
            border-radius: 8px; 
            border-left: 4px solid #667eea; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
            transition: all 0.3s ease;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
        }
        .device-info div:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(0,0,0,0.12); 
        }
        .device-info strong { 
            color: #2c3e50; 
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 4px;
        }
        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .card { 
            background: white;
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.12); 
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.18); 
        }
        .card h2 { 
            font-size: clamp(1.2rem, 4vw, 1.5rem); 
            margin-bottom: 15px; 
            color: #2c3e50; 
            border-bottom: 3px solid #667eea; 
            padding-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-weight: 600;
        }
        .card.battery h2::before { content: 'üîã'; font-size: clamp(1.3rem, 4vw, 1.8rem); }
        .card.solar h2::before { content: '‚ö°'; font-size: clamp(1.3rem, 4vw, 1.8rem); }
        .card.temperature h2::before { content: 'üå°Ô∏è'; font-size: clamp(1.3rem, 4vw, 1.8rem); }
        .card.status-card h2::before { content: 'üìä'; font-size: clamp(1.3rem, 4vw, 1.8rem); }
        
        .metric { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 1px solid #ecf0f1;
            gap: 10px;
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { 
            font-weight: 500; 
            color: #7f8c8d; 
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            flex: 1;
        }
        .metric-value { 
            font-weight: 700; 
            font-size: clamp(1rem, 3vw, 1.3rem); 
            color: #2c3e50;
            text-align: right;
        }
        .metric-value.large { 
            font-size: clamp(1.3rem, 4vw, 2rem); 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .status-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px;
            flex-shrink: 0;
        }
        .status-ok { 
            background: #2ecc71; 
            box-shadow: 0 0 12px rgba(46,204,113,0.6); 
        }
        .status-error { 
            background: #e74c3c; 
            box-shadow: 0 0 12px rgba(231,76,60,0.6); 
        }
        .alert-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px; 
            font-size: clamp(0.8rem, 2vw, 0.9rem); 
        }
        .alert-item { 
            padding: 10px 12px; 
            border-radius: 8px; 
            background: white; 
            border-left: 4px solid #95a5a6; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
            transition: all 0.3s ease;
            font-weight: 500;
            word-break: break-word;
        }
        .alert-item:hover { 
            transform: translateX(3px); 
        }
        .alert-item.active { 
            background: linear-gradient(135deg, #e74c3c, #c0392b); 
            color: white; 
            font-weight: 700; 
            border-left: 4px solid #c0392b; 
            animation: alertPulse 1.5s infinite; 
        }
        @keyframes alertPulse { 
            0%, 100% { box-shadow: 0 4px 10px rgba(231,76,60,0.4); } 
            50% { box-shadow: 0 8px 25px rgba(231,76,60,0.7); } 
        }
        .chart-container { 
            background: white;
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.12); 
            margin-top: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .chart-container h2 { 
            color: #2c3e50; 
            font-size: clamp(1.2rem, 4vw, 1.7rem); 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .chart-container h2::before {
            content: 'üìà';
            font-size: clamp(1.5rem, 5vw, 2rem);
        }
        .chart-wrapper { 
            position: relative; 
            height: 300px; 
            width: 100%;
            margin-top: 15px;
        }
        .date-selector { 
            margin-bottom: 15px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap; 
            padding: 15px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            border-radius: 10px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        .date-selector label { 
            font-weight: 700; 
            color: #2c3e50;
            font-size: clamp(0.9rem, 2.5vw, 1.05rem);
        }
        .date-selector input { 
            padding: 10px 12px; 
            border: 2px solid #667eea; 
            border-radius: 8px; 
            font-size: clamp(0.85rem, 2.5vw, 1rem); 
            background: white; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.08); 
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            min-width: 150px;
        }
        .date-selector input:focus { 
            outline: none; 
            border-color: #764ba2; 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        .date-selector button { 
            padding: 10px 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: clamp(0.85rem, 2.5vw, 1.05rem); 
            font-weight: 700; 
            transition: all 0.3s ease; 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        .date-selector button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); 
        }
        .date-selector button:active {
            transform: translateY(0);
        }
        .date-selector button:disabled { 
            background: #95a5a6; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .chart-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .chart-controls button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.75rem, 2vw, 0.95rem);
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
            flex: 1 1 auto;
            min-width: 100px;
        }
        .chart-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .chart-controls button:active {
            transform: translateY(0);
        }
        .sensors { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 15px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            border-radius: 10px; 
            margin-bottom: 15px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        .sensor-item { 
            display: flex; 
            align-items: center; 
            background: white; 
            padding: 8px 12px; 
            border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: all 0.3s ease; 
            cursor: pointer;
            border: 2px solid transparent;
            flex: 0 1 auto;
        }
        .sensor-item:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            border-color: currentColor;
        }
        .sensor-item input[type="checkbox"] { 
            margin-right: 6px; 
            cursor: pointer; 
            width: 18px; 
            height: 18px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .sensor-item label { 
            cursor: pointer; 
            font-weight: 600; 
            font-size: clamp(0.75rem, 2vw, 0.95rem); 
            user-select: none;
            white-space: nowrap;
        }
        .log-status { 
            padding: 12px; 
            background: linear-gradient(135deg, #2ecc71, #27ae60); 
            border-radius: 8px; 
            font-size: clamp(0.85rem, 2.5vw, 1rem); 
            color: white; 
            text-align: center; 
            margin-top: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        .zoom-instructions {
            text-align: center;
            color: #7f8c8d;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            margin-top: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-style: italic;
        }
        .zoom-instructions::before {
            content: 'üí° ';
        }
        
        /* Responsive untuk HP */
        @media (max-width: 768px) { 
            body { padding: 8px; }
            .container { padding: 12px; border-radius: 12px; }
            .header { padding: 15px 10px; margin-bottom: 12px; }
            .status-bar { padding: 10px 12px; font-size: 0.85rem; }
            .device-info { 
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 12px;
            }
            .status-grid { 
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .card { padding: 15px; }
            .metric { padding: 8px 0; }
            .alert-grid { 
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .chart-wrapper { height: 250px; }
            .chart-container { padding: 15px; }
            .date-selector { 
                padding: 12px;
                gap: 8px;
            }
            .date-selector input,
            .date-selector button {
                width: 100%;
                min-width: auto;
            }
            .chart-controls {
                gap: 6px;
            }
            .chart-controls button {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .sensors {
                padding: 12px;
                gap: 6px;
            }
            .sensor-item {
                padding: 6px 10px;
            }
            .sensor-item label {
                font-size: 0.8rem;
            }
        }
        
        /* Responsive untuk tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-wrapper { height: 350px; }
        }
        
        /* Responsive untuk desktop besar */
        @media (min-width: 1025px) {
            body { padding: 20px; }
            .container { padding: 30px; }
            .chart-wrapper { height: 450px; }
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; } 
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } 
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; } 
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #764ba2, #667eea); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MPPT Solar Monitoring </h1>
            <h2>Modul Sakti Online</h2>
        </div>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connStatus">Connecting...</span>
            </div>
            <div>Last: <span id="lastUpdate">-</span></div>
        </div>

        <div class="device-info">
            <div><strong>Uptime:</strong> <span id="uptime">-</span></div>
            <div><strong>Free RAM:</strong> <span id="heap">-</span> Bytes</div>
            <div><strong>WiFi RSSI:</strong> <span id="wifi">-</span></div>
            <div><strong>Local IP:</strong> <span id="ip">-</span></div>
            <div><strong>MPPT Time:</strong> <span id="datetime">-</span></div>
			<div><strong>SW Version:</strong> <span id="sw_version">-</span></div>
        </div>

        <div class="status-grid">
            <div class="card battery">
                <h2>Battery</h2>
                <div class="metric"><span class="metric-label">Voltage</span><span class="metric-value large" id="voltBat">-- V</span></div>
                <div class="metric"><span class="metric-label">Current</span><span class="metric-value" id="current">-- A</span></div>
                <div class="metric"><span class="metric-label">Power</span><span class="metric-value" id="power">-- W</span></div>
                <div class="metric"><span class="metric-label">Peak Power</span><span class="metric-value" id="peakPower">-- W</span></div>
            </div>
            <div class="card solar">
                <h2>Solar</h2>
                <div class="metric"><span class="metric-label">PV Voltage</span><span class="metric-value large" id="voltPv">-- V</span></div>
                <div class="metric"><span class="metric-label">Today Energy</span><span class="metric-value" id="todayEnergy">-- kWh</span></div>
                <div class="metric"><span class="metric-label">Total Energy</span><span class="metric-value" id="totalEnergy">-- kWh</span></div>
                <div class="metric"><span class="metric-label">Load %</span><span class="metric-value" id="loadPercent">-- %</span></div>
            </div>
            <div class="card temperature">
                <h2>Temperature</h2>
                <div class="metric"><span class="metric-label">Environment</span><span class="metric-value" id="tempEnvi">-- ¬∞C</span></div>
                <div class="metric"><span class="metric-label">Heatsink</span><span class="metric-value" id="tempMppt">-- ¬∞C</span></div>
                <div class="metric"><span class="metric-label">Status Code</span><span class="metric-value" id="statusCode">--</span></div>
            </div>
            <div class="card status-card">
                <h2>Status</h2>
                <div class="metric"><span class="metric-label">Load Out</span><span id="statusLoadOut">-</span></div>
                <div class="metric"><span class="metric-label">Charging</span><span id="statusCharging">-</span></div>
                <div class="metric"><span class="metric-label">Bat Full</span><span id="statusBatFull">-</span></div>
                <div class="metric"><span class="metric-label">Warning</span><span id="statusWarn">-</span></div>
                <div class="metric"><span class="metric-label">Fault</span><span id="statusFault">-</span></div>
            </div>
        </div>

        <div class="card"><h2 style="border-color: #e74c3c;">‚ö†Ô∏è Alarms</h2><div class="alert-grid" id="alarmGrid"></div></div>
        <div class="card" style="margin-top: 15px;"><h2 style="border-color: #e74c3c;">‚ùå Faults</h2><div class="alert-grid" id="faultGrid"></div></div>

        <div class="chart-container">
            <h2>Historical Data</h2>
            <div class="date-selector">
                <label>Date:</label>
                <input type="date" id="chartDate">
                <button id="loadBtn" onclick="requestLogData()">Load Data</button>
            </div>
            <div class="log-status" id="logStatus"></div>
            <div class="sensors" id="checkboxContainer"></div>
            <div class="chart-controls">
                <button onclick="resetZoom()">üîÑ Reset</button>
                <button onclick="zoomIn()">üîç Zoom In</button>
                <button onclick="zoomOut()">üîé Zoom Out</button>
                <button onclick="showAllData()">üëÅÔ∏è Show All</button>
                <button onclick="hideAllData()">üö´ Hide All</button>
            </div>
            <div class="chart-wrapper"><canvas id="historyChart"></canvas></div>
            <div class="zoom-instructions">Tip: Scroll to zoom, Click and drag to pan</div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        let chart = null;
        let datasets = [];
        let client = null;
		let client2 = null;
        let deviceId = null;

        // === Log Streaming State ===
        let isCollectingLog = false;
        let logBuffer = "";
        const START_MARKER = "START LOG";
        const END_MARKER = ">>> END LOG <<<";

        // === Chart Colors with Icons ===
        const chartConfig = [
            { label: '‚ö° PV Voltage (V)', color: '#e74c3c', icon: '‚ö°' },
            { label: 'üîã Battery Voltage (V)', color: '#3498db', icon: 'üîã' },
            { label: '‚öôÔ∏è Current (A)', color: '#2ecc71', icon: '‚öôÔ∏è' },
            { label: 'üí° Power (W)', color: '#f39c12', icon: 'üí°' },
            { label: 'üåü Peak Power (W)', color: '#e67e22', icon: 'üåü' },
            { label: 'üìä Day Energy (kWh)', color: '#9b59b6', icon: 'üìä' },
            { label: 'üìà Total Energy (kWh)', color: '#8e44ad', icon: 'üìà' },
            { label: '‚öñÔ∏è Load %', color: '#1abc9c', icon: '‚öñÔ∏è' },
            { label: 'üå°Ô∏è Env Temp (¬∞C)', color: '#16a085', icon: 'üå°Ô∏è' },
            { label: 'üî• Heatsink Temp (¬∞C)', color: '#c0392b', icon: 'üî•' },
            { label: 'üì° Status Code', color: '#34495e', icon: 'üì°' },
            { label: 'üì∂ RSSI (dBm)', color: '#7f8c8d', icon: 'üì∂' }
        ];

        // === Get Device ID ===
        function getDeviceId() {
            const params = new URLSearchParams(location.search);
            let id = params.get('id');
            if (id) return id.trim();
            id = prompt("Masukkan ID MPPT (contoh: MPPT001):");
            if (!id?.trim()) { alert("ID wajib diisi!"); return null; }
            const url = new URL(location);
            url.searchParams.set('id', id.trim());
            history.replaceState({}, '', url);
            return id.trim();
        }

        // === Format Uptime ===
        function formatUptime(s) {
            const d = Math.floor(s / 86400);
            const h = Math.floor((s % 86400) / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${d}d ${h}h ${m}m ${s % 60}s`;
        }

        // === Status Dot ===
        function statusDot(active) {
            return `<span class="status-indicator ${active ? 'status-error' : 'status-ok'}"></span>${active ? 'ACTIVE' : 'OFF'}`;
        }

        // === Update Time ===
        function updateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // === Update UI ===
        function updateUI(json) {
			//console.log(json);
            const d = json.data, dev = json.device;
			var legal = dev.legal === 1 ? "Connected - Registered" : "Connected - Unregistered";
			document.getElementById('connStatus').textContent = legal;
            document.getElementById('uptime').textContent = formatUptime(dev.uptime);
			var percent = 
            document.getElementById('heap').textContent = dev.heap.toLocaleString()+" (" + (dev.heap/57000 *100).toFixed(0) +"%) ";
            document.getElementById('wifi').textContent = dev.wifi;
            document.getElementById('ip').textContent = dev.ip;
			document.getElementById('sw_version').textContent = dev["fw version"];
			
            document.getElementById('datetime').textContent = `${d.year}-${String(d.month).padStart(2,'0')}-${String(d.date).padStart(2,'0')} ${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}:${String(d.second).padStart(2,'0')}`;
            document.getElementById('voltBat').textContent = d.volt_battery.toFixed(2) + ' V';
            document.getElementById('current').textContent = d.current.toFixed(2) + ' A';
            document.getElementById('power').textContent = d.power + ' W';
            document.getElementById('peakPower').textContent = d.peak_power + ' W';
            document.getElementById('voltPv').textContent = d.volt_pv.toFixed(1) + ' V';
            document.getElementById('todayEnergy').textContent = d.today_energy.toFixed(3) + ' kWh';
            document.getElementById('totalEnergy').textContent = d.total_energy.toFixed(1) + ' kWh';
            document.getElementById('loadPercent').textContent = d.load_percent + ' %';
            document.getElementById('tempEnvi').textContent = d.temp_envi + ' ¬∞C';
            document.getElementById('tempMppt').textContent = d.temp_mppt + ' ¬∞C';
            document.getElementById('statusCode').textContent = "0x"+ d.status_code;

            document.getElementById('statusLoadOut').innerHTML = statusDot(d.status.load_out);
            document.getElementById('statusCharging').innerHTML = statusDot(d.status.charging);
            document.getElementById('statusBatFull').innerHTML = statusDot(d.status.bat_full);
            document.getElementById('statusWarn').innerHTML = statusDot(d.status.warn);
            document.getElementById('statusFault').innerHTML = statusDot(d.status.fault);

            const alarmGrid = document.getElementById('alarmGrid'); alarmGrid.innerHTML = '';
            for (const [k, v] of Object.entries(d.alarm)) {
                const el = document.createElement('div');
                el.className = 'alert-item' + (v ? ' active' : '');
                el.textContent = k.replace(/_/g, ' ').toUpperCase();
                alarmGrid.appendChild(el);
            }
            const faultGrid = document.getElementById('faultGrid'); faultGrid.innerHTML = '';
            for (const [k, v] of Object.entries(d.fault)) {
                const el = document.createElement('div');
                el.className = 'alert-item' + (v ? ' active' : '');
                el.textContent = k.replace(/_/g, ' ').toUpperCase();
                faultGrid.appendChild(el);
            }
            updateTime();
        }

        // === Init MQTT ===
        function initMQTT() {
            deviceId = getDeviceId();
            if (!deviceId) return;

            const options = {
                clientId: 'web_' + Math.random().toString(16).slice(2, 10),
                username: 'public',
                password: 'public',
                keepalive: 60,
                reconnectPeriod: 1000,
                clean: true
            };

            client = mqtt.connect('wss://public.cloud.shiftr.io', options);

            client.on('connect', () => {
                console.log('MQTT Connected');
                client.subscribe(`mpptMon/${deviceId}/TX`, err => { if (err) console.error(err); });
                client.subscribe(`${deviceId}/TX/log`, err => { if (err) console.error(err); });
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connStatus').textContent = 'Connected';
            });

            client.on('message', (topic, message) => {
                const payload = message.toString();

                if (topic === `mpptMon/${deviceId}/TX`) {
                    try { updateUI(JSON.parse(payload)); } catch (e) { console.error('JSON Error:', e); }
                } 
                else if (topic === `${deviceId}/TX/log`) {
                    //console.log(payload);
                    handleLogChunk(payload);
                }
            });

            client.on('error', err => console.error('MQTT Error:', err));
            client.on('offline', () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('connStatus').textContent = 'Offline';
            });

			const options2 = {
                clientId: 'web_' + Math.random().toString(16).slice(2, 10),
                username: 'emqx',
                password: 'emqx',
                keepalive: 60,
                reconnectPeriod: 1000,
                clean: true
            };

            client2 = mqtt.connect('wss://broker.emqx.io:8084', options);

            client2.on('connect', () => {
                console.log('MQTT Connected');
                client2.subscribe(`mpptMon/${deviceId}/TX`, err => { if (err) console.error(err); });
                client2.subscribe(`${deviceId}/TX/log`, err => { if (err) console.error(err); });
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connStatus').textContent = 'Connected';
            });

            client2.on('message', (topic, message) => {
                const payload = message.toString();

                if (topic === `mpptMon/${deviceId}/TX`) {
                    try { updateUI(JSON.parse(payload)); } catch (e) { console.error('JSON Error:', e); }
                } 
                else if (topic === `${deviceId}/TX/log`) {
                    //console.log(payload);
                    handleLogChunk(payload);
                }
            });

            client2.on('error', err => console.error('MQTT Error:', err));
            client2.on('offline', () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('connStatus').textContent = 'Offline';
            });
        }
		let panjang_data_log;
		

        // === Handle Log Chunk ===
        function handleLogChunk(chunk) {
            if (chunk.includes(START_MARKER)) {
				const match = chunk.match(/\((\d+)\)/);
				panjang_data_log = match ? parseInt(match[1]) : null;
                isCollectingLog = true;
                logBuffer = "";
                updateLogStatus("Menerima data log...") ;
                document.getElementById('loadBtn').disabled = true;
                console.log("Log transfer started");
                const startIdx = chunk.indexOf("<<<") + 3;
				
                if (chunk.length > startIdx) logBuffer += chunk.substring(startIdx);
                return;
            }

            if (!isCollectingLog) return;

            if (chunk.includes(END_MARKER)) {
                const endIdx = chunk.indexOf(END_MARKER);
                logBuffer += chunk.substring(0, endIdx);
                isCollectingLog = false;
                updateLogStatus("Log selesai. Rendering grafik...");
                setTimeout(() => {
                    renderChartFromCSV(logBuffer.trim());
                    updateLogStatus("Grafik siap!");
                    document.getElementById('loadBtn').disabled = false;
                }, 100);
                console.log("Log transfer completed");
                return;
            }

            logBuffer += chunk;
            updateLogStatus(`Menerima data... (${(logBuffer.length/1024).toFixed(1)} KB -> ${(logBuffer.length/panjang_data_log*100).toFixed(0)}% ) `);
        }

        function updateLogStatus(msg) {
            const el = document.getElementById('logStatus');
            el.textContent = msg;
            el.style.background = isCollectingLog 
                ? 'linear-gradient(135deg, #f39c12, #e67e22)' 
                : 'linear-gradient(135deg, #2ecc71, #27ae60)';
        }

        // === Request Log ===
        function requestLogData() {
            if (!client?.connected) return alert('MQTT belum terhubung!');
            const date = document.getElementById('chartDate').value;
            if (!date) return alert('Pilih tanggal!');
            const [y, m, d] = date.split('-');
            const msg = `log log/${y}/${m}/${d}.csv`;
            client.publish(`${deviceId}/RX`, msg);
            console.log('Log requested:', msg);
            updateLogStatus("Menunggu data dari perangkat...");
        }

        // === Render Chart ===
        function renderChartFromCSV(csv) {
            const lines = csv.trim().split('\n').filter(l => l && !l.startsWith('#'));
            const data = { time: [], voltPv: [], voltBat: [], current: [], power: [], PeakPower: [], Day_Energy: [], Total_energy: [], percent_load: [], env_temp: [], heatSink_temp: [], status_code: [], RSSI: [] };

            lines.forEach(l => {
                const v = l.split(',');
                if (v.length >= 13) {
                    data.time.push(v[0]);
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(v[i]);
                        data[Object.keys(data)[i]].push(isNaN(val) ? 0 : val);
                    }
                }
            });

            const ctx = document.getElementById('historyChart').getContext('2d');
            if (chart) chart.destroy();

            datasets = chartConfig.map((config, i) => ({
                label: config.label,
                data: Object.values(data)[i + 1],
                borderColor: config.color,
                backgroundColor: config.color + '20',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: config.color,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                hidden: i > 2
            }));

            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: data.time, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    modifierKey: null
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                speed: 0.1
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: null
                            },
                            limits: {
                                x: {min: 'original', max: 'original'}
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: '‚è∞ Time',
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            }, 
                            ticks: { 
                                maxTicksLimit: 15,
                                color: '#7f8c8d',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: 'üìä Value',
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: { 
                        mode: 'nearest', 
                        axis: 'x', 
                        intersect: false 
                    },
                    animation: { 
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            createCheckboxes();
        }

        function createCheckboxes() {
            const c = document.getElementById('checkboxContainer'); 
            c.innerHTML = '';
            datasets.forEach((d, i) => {
                const div = document.createElement('div'); 
                div.className = 'sensor-item';
                div.style.borderColor = d.borderColor;
                
                const cb = document.createElement('input'); 
                cb.type = 'checkbox'; 
                cb.checked = !d.hidden; 
                cb.id = `cb${i}`; 
                cb.style.accentColor = d.borderColor;
                cb.onchange = () => { 
                    datasets[i].hidden = !cb.checked; 
                    chart.update(); 
                };
                
                const lbl = document.createElement('label'); 
                lbl.htmlFor = `cb${i}`; 
                lbl.textContent = d.label; 
                lbl.style.color = d.borderColor;
                
                div.append(cb, lbl); 
                c.appendChild(div);
            });
        }

        // === Chart Control Functions ===
        function resetZoom() {
            if (chart) {
                chart.resetZoom();
            }
        }

        function zoomIn() {
            if (chart) {
                chart.zoom(1.2);
            }
        }

        function zoomOut() {
            if (chart) {
                chart.zoom(0.8);
            }
        }

        function showAllData() {
            if (chart && datasets.length > 0) {
                datasets.forEach((dataset, i) => {
                    dataset.hidden = false;
                    const cb = document.getElementById(`cb${i}`);
                    if (cb) cb.checked = true;
                });
                chart.update();
            }
        }

        function hideAllData() {
            if (chart && datasets.length > 0) {
                datasets.forEach((dataset, i) => {
                    dataset.hidden = true;
                    const cb = document.getElementById(`cb${i}`);
                    if (cb) cb.checked = false;
                });
                chart.update();
            }
        }

        // === INIT ===
        document.getElementById('chartDate').valueAsDate = new Date();
        initMQTT();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>

