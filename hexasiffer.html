<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hex Reader — MQTT / Manual</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-4 md:p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header dengan gradient -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl shadow-xl p-6 mb-6">
      <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
        <span class="text-4xl">🔍</span> Hex Reader
      </h1>
      <p class="text-blue-100 text-sm">MQTT Real-time Monitor & Manual Hex Analyzer</p>
    </div>

    <!-- Connection Panel (Collapsible) -->
    <div class="bg-white rounded-2xl shadow-lg mb-6 overflow-hidden">
      <div class="bg-gradient-to-r from-slate-700 to-slate-800 p-4 flex justify-between items-center cursor-pointer hover:from-slate-600 hover:to-slate-700 transition" onclick="document.getElementById('connPanel').classList.toggle('hidden')">
        <div class="flex items-center gap-3">
          <span class="text-2xl">🌐</span>
          <h2 class="text-lg font-semibold text-white">MQTT Connection</h2>
        </div>
        <div class="flex items-center gap-3">
          <div id="connStatusBadge" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-full shadow-md">Disconnected</div>
          <svg class="w-5 h-5 text-white transition-transform" id="connToggleIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
      </div>
      <div id="connPanel" class="p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">📡 Topic (dari URL ?topic=...)</label>
            <input id="topic" class="w-full border-2 border-slate-300 rounded-lg p-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition" placeholder="topic/diisi/dari-url" />
          </div>
          <div class="flex items-end gap-2">
            <button id="connectBtn" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
              <span>▶</span> Connect
            </button>
            <button id="disconnectBtn" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
              <span>⏹</span> Disconnect
            </button>
          </div>
        </div>
        <input id="broker" class="hidden" value="wss://public.cloud.shiftr.io" />
        <input id="username" class="hidden" value="public" />
        <input id="password" type="password" class="hidden" value="public" />
      </div>
    </div>

    <!-- Control Panel -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
        <span class="text-2xl">⚙️</span> Data Processing & Filters
      </h2>
      
      <!-- Length Filters -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">📏 Filter Mode</label>
          <select id="filterMode" class="w-full border-2 border-slate-300 rounded-lg p-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition bg-white">
            <option value="min">Minimum Length</option>
            <option value="exact">Exact Length</option>
            <option value="range">Range Length</option>
          </select>
        </div>
        <div id="minLenContainer">
          <label class="block text-sm font-medium text-slate-700 mb-2">Min Length (bytes)</label>
          <input id="minLen" type="number" min="1" class="w-full border-2 border-slate-300 rounded-lg p-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition" value="11" />
        </div>
        <div id="exactLenContainer" class="hidden">
          <label class="block text-sm font-medium text-slate-700 mb-2">Exact Length (bytes)</label>
          <input id="exactLen" type="number" min="1" class="w-full border-2 border-slate-300 rounded-lg p-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition" value="11" />
        </div>
        <div id="rangeLenContainer" class="hidden">
          <label class="block text-sm font-medium text-slate-700 mb-2">Length Range (bytes)</label>
          <div class="flex gap-2 items-center">
            <input id="minRange" type="number" min="1" class="flex-1 border-2 border-slate-300 rounded-lg p-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition" value="10" placeholder="Min" />
            <span class="text-slate-500 font-bold">—</span>
            <input id="maxRange" type="number" min="1" class="flex-1 border-2 border-slate-300 rounded-lg p-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition" value="20" placeholder="Max" />
          </div>
        </div>
      </div>

      <!-- Processing Options -->
      <div class="flex gap-3 flex-wrap mb-5">
        <label class="inline-flex items-center px-4 py-2.5 bg-blue-50 rounded-lg hover:bg-blue-100 cursor-pointer transition-all hover:shadow-md border-2 border-blue-200">
          <input id="stripFrame" type="checkbox" class="mr-2 w-4 h-4 text-blue-600 rounded">
          <span class="text-sm font-medium text-slate-700">🔪 Strip start/stop (0x7E...0xD0)</span>
        </label>
        <label class="inline-flex items-center px-4 py-2.5 bg-purple-50 rounded-lg hover:bg-purple-100 cursor-pointer transition-all hover:shadow-md border-2 border-purple-200">
          <input id="asciiHexMode" type="checkbox" class="mr-2 w-4 h-4 text-purple-600 rounded">
          <span class="text-sm font-medium text-slate-700">🔄 ASCIIHEX → Hex</span>
        </label>
        <label class="inline-flex items-center px-4 py-2.5 bg-green-50 rounded-lg hover:bg-green-100 cursor-pointer transition-all hover:shadow-md border-2 border-green-200">
          <input id="hexToAscii" type="checkbox" class="mr-2 w-4 h-4 text-green-600 rounded">
          <span class="text-sm font-medium text-slate-700">👁️ Show ASCII Preview</span>
        </label>
      </div>

      <!-- Manual Input -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">✍️ Manual Input / Received Hex</label>
        <textarea id="manualInput" rows="3" class="w-full border-2 border-slate-300 rounded-lg p-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-mono text-sm bg-slate-50" placeholder="Contoh: 3F 55 68 0C DD 0C ... atau 7E3F55680CDD0CD0"></textarea>
        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="processManual" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition shadow-md hover:shadow-lg flex items-center gap-2">
            <span>▶</span> Process Manual
          </button>
          <button id="simulate" class="px-5 py-2.5 bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg transition shadow-md hover:shadow-lg flex items-center gap-2">
            <span>🎲</span> Simulate Random
          </button>
        </div>
      </div>

      <div id="warn" class="mt-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded-lg hidden shadow-md"></div>
    </div>

    <!-- Data Preview -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center flex-wrap gap-3">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
          <span class="text-2xl">📊</span> Data Preview
        </h2>
        <div class="flex items-center gap-2 bg-white/20 backdrop-blur px-4 py-2 rounded-lg shadow-lg">
          <span class="text-white text-sm font-medium">Length:</span>
          <span id="dataLen" class="text-white text-xl font-bold">0</span>
          <span class="text-white text-sm">bytes</span>
        </div>
      </div>

      <div class="p-6">
        <!-- Raw Hex Display -->
        <div class="mb-4 p-4 bg-slate-50 rounded-xl border-2 border-slate-200 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-sm font-semibold text-slate-700">🔤 RAW HEX:</span>
            <button onclick="navigator.clipboard.writeText(document.getElementById('rawHex').textContent)" class="text-xs px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition shadow-sm hover:shadow-md">📋 Copy</button>
          </div>
          <div id="rawHex" class="font-mono text-sm text-slate-800 break-all leading-relaxed p-2 bg-white rounded border border-slate-200"></div>
        </div>

        <!-- ASCII Preview -->
        <div id="asciiPreview" class="mb-4 p-4 bg-green-50 rounded-xl border-2 border-green-300 hidden shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-sm font-semibold text-green-700">📝 ASCII:</span>
          </div>
          <div id="asciiText" class="font-mono text-sm text-green-800 break-all leading-relaxed p-2 bg-white rounded border border-green-200"></div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto rounded-xl border-2 border-slate-200 shadow-md">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gradient-to-r from-slate-700 to-slate-600 text-white">
                <th class="px-4 py-3 text-left font-semibold">Offset</th>
                <th class="px-4 py-3 text-left font-semibold">Hex</th>
                <th class="px-4 py-3 text-left font-semibold">Decimal</th>
                <th class="px-4 py-3 text-left font-semibold">Uint16 BE</th>
                <th class="px-4 py-3 text-left font-semibold">Int16 BE</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const hexByte = (n) => ('0' + (n & 0xFF).toString(16).toUpperCase()).slice(-2);
    const isPrintable = (ch) => ch >= 0x20 && ch <= 0x7E;

    const brokerEl = document.getElementById('broker');
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const topicEl = document.getElementById('topic');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const connStatusBadge = document.getElementById('connStatusBadge');
    const manualInput = document.getElementById('manualInput');
    const processManual = document.getElementById('processManual');
    const simulateBtn = document.getElementById('simulate');
    const tableBody = document.getElementById('tableBody');
    const dataLenEl = document.getElementById('dataLen');
    const rawHexEl = document.getElementById('rawHex');
    const asciiPreview = document.getElementById('asciiPreview');
    const asciiText = document.getElementById('asciiText');
    const minLenEl = document.getElementById('minLen');
    const exactLenEl = document.getElementById('exactLen');
    const minRangeEl = document.getElementById('minRange');
    const maxRangeEl = document.getElementById('maxRange');
    const filterModeEl = document.getElementById('filterMode');
    const warnEl = document.getElementById('warn');
    const stripFrameEl = document.getElementById('stripFrame');
    const hexToAsciiEl = document.getElementById('hexToAscii');
    const asciiHexModeEl = document.getElementById('asciiHexMode');

    let client = null;
    const urlParams = new URLSearchParams(location.search);
    const urlTopic = urlParams.get('topic');
    if (urlTopic) {
        topicEl.value = urlTopic;
        // document.getElementById('connPanel').classList.remove('hidden');
        connectMQTT();
    }

    // Filter mode switcher
    filterModeEl.onchange = () => {
      document.getElementById('minLenContainer').classList.add('hidden');
      document.getElementById('exactLenContainer').classList.add('hidden');
      document.getElementById('rangeLenContainer').classList.add('hidden');
      
      if (filterModeEl.value === 'min') {
        document.getElementById('minLenContainer').classList.remove('hidden');
      } else if (filterModeEl.value === 'exact') {
        document.getElementById('exactLenContainer').classList.remove('hidden');
      } else if (filterModeEl.value === 'range') {
        document.getElementById('rangeLenContainer').classList.remove('hidden');
      }
    };

    function setStatus(s) {
      connStatusBadge.textContent = s;
      connStatusBadge.className = 'px-3 py-1 text-white text-xs font-medium rounded-full shadow-md transition-all ' + 
        (s === 'Connected' ? 'bg-green-500' : s === 'Connecting...' ? 'bg-yellow-500' : 'bg-red-500');
    }

    function connectMQTT() {
      const broker = brokerEl.value.trim();
      const username = userEl.value.trim();
      const password = passEl.value;
      const topic = topicEl.value.trim();
      if (!broker || !topic) {
        alert('Broker dan topic harus diisi.');
        return;
      }
      setStatus('Connecting...');
      client = mqtt.connect(broker, { username, password, reconnectPeriod: 5000 });
      client.on('connect', () => {
        setStatus('Connected');
        client.subscribe(topic+"/TX");
        client.subscribe("sysMon/"+topic);
      });
      client.on('message', (t, payload) => {
        let bytes = decodePayload(payload);
        if (bytes) handleIncoming(bytes);
      });
      client.on('error', e => setStatus('Error'));
    }
    function disconnectMQTT(){ if(client){client.end(true);} setStatus('Disconnected'); }
    connectBtn.onclick=connectMQTT; 
    disconnectBtn.onclick=disconnectMQTT;

    function parseHexStringToBytes(s){
      let cleaned = s.replace(/0x/gi,'').replace(/[^0-9A-Fa-f]/g,'');
      if (cleaned.length%2===1) cleaned = cleaned.slice(0,-1);
      const out=[]; 
      for(let i=0;i<cleaned.length;i+=2){ 
        out.push(parseInt(cleaned.substr(i,2),16)); 
      }
      return out;
    }

    function decodePayload(payload){
      if (asciiHexModeEl.checked){
        const s=(typeof payload==='string')?payload:new TextDecoder().decode(payload);
        return parseHexStringToBytes(s);
      }
      if (payload instanceof Uint8Array) return Array.from(payload);
      if (typeof payload==='string') return parseHexStringToBytes(payload);
      return null;
    }

    function handleIncoming(bytes){
      // modifikasi sesuai checkbox
      if (stripFrameEl.checked && bytes.length>=2){
        if (bytes[0]===0x7E && bytes[bytes.length-1]===0xD0){
          bytes=bytes.slice(1,-1);
        }
      }

      // Check filter mode
      const filterMode = filterModeEl.value;
      let passFilter = false;
      let filterMsg = '';

      if (filterMode === 'min') {
        const minLen = parseInt(minLenEl.value) || 1;
        passFilter = bytes.length >= minLen;
        filterMsg = `Data length ${bytes.length} < min length ${minLen}`;
      } else if (filterMode === 'exact') {
        const exactLen = parseInt(exactLenEl.value) || 1;
        passFilter = bytes.length === exactLen;
        filterMsg = `Data length ${bytes.length} ≠ exact length ${exactLen}`;
      } else if (filterMode === 'range') {
        const minRange = parseInt(minRangeEl.value) || 1;
        const maxRange = parseInt(maxRangeEl.value) || 100;
        passFilter = bytes.length >= minRange && bytes.length <= maxRange;
        filterMsg = `Data length ${bytes.length} outside range ${minRange}-${maxRange}`;
      }

      if (!passFilter) {
        warnEl.innerHTML = `<strong>⚠️ Filtered:</strong> ${filterMsg}`;
        warnEl.classList.remove('hidden');
        return;
      } else {
        warnEl.classList.add('hidden');
      }

      updateTable(bytes);
    }

    function updateTable(bytes){
      tableBody.innerHTML='';
      dataLenEl.textContent=bytes.length;
      rawHexEl.textContent=bytes.map(hexByte).join(' ');

      if (hexToAsciiEl.checked){
        asciiPreview.classList.remove('hidden');
        asciiText.textContent=bytes.map(b=>isPrintable(b)?String.fromCharCode(b):'.').join('');
      } else asciiPreview.classList.add('hidden');

      for (let i=0;i<bytes.length;i++){
        const tr=document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-white hover:bg-blue-50' : 'bg-slate-50 hover:bg-blue-50';
        tr.style.transition = 'background-color 0.2s';

        const tdOff=document.createElement('td'); 
        tdOff.className='px-4 py-2.5 border-b border-slate-200 font-mono text-slate-600'; 
        tdOff.textContent=i; 
        tr.appendChild(tdOff);

        const tdHex=document.createElement('td'); 
        tdHex.className='px-4 py-2.5 border-b border-slate-200 font-mono font-semibold text-blue-700'; 
        tdHex.textContent=hexByte(bytes[i]); 
        tr.appendChild(tdHex);

        const tdDec=document.createElement('td'); 
        tdDec.className='px-4 py-2.5 border-b border-slate-200 text-slate-700'; 
        tdDec.textContent=bytes[i]; 
        tr.appendChild(tdDec);

        // Uint16 BE
        const tdU16=document.createElement('td'); 
        tdU16.className='px-4 py-2.5 border-b border-slate-200 font-mono text-purple-700';
        if (i+1<bytes.length){ 
          const val=(bytes[i]<<8)|bytes[i+1]; 
          tdU16.textContent=val; 
        } else tdU16.textContent='-';
        tr.appendChild(tdU16);

        // Int16 BE
        const tdI16=document.createElement('td'); 
        tdI16.className='px-4 py-2.5 border-b border-slate-200 font-mono text-indigo-700';
        if (i+1<bytes.length){
          let val=(bytes[i]<<8)|bytes[i+1]; 
          if (val&0x8000) val-=0x10000; 
          tdI16.textContent=val;
        } else tdI16.textContent='-';
        tr.appendChild(tdI16);

        tableBody.appendChild(tr);
      }
    }

    processManual.onclick=()=>{ 
      let txt=manualInput.value.trim(); 
      if(!txt)return;
      let bytes=parseHexStringToBytes(txt); 
      handleIncoming(bytes); 
    };
    
    simulateBtn.onclick=()=>{ 
      let n = 12;
      if (filterModeEl.value === 'min') {
        n = Math.max(12, parseInt(minLenEl.value) || 12);
      } else if (filterModeEl.value === 'exact') {
        n = parseInt(exactLenEl.value) || 12;
      } else if (filterModeEl.value === 'range') {
        const minR = parseInt(minRangeEl.value) || 10;
        const maxR = parseInt(maxRangeEl.value) || 20;
        n = Math.floor(Math.random() * (maxR - minR + 1)) + minR;
      }
      
      const arr = [];
      for(let i=0; i<n-2; i++) arr.push(Math.floor(Math.random()*256));
      arr.unshift(0x7E); 
      arr.push(0xD0); 
      manualInput.value = arr.map(hexByte).join(' '); 
      handleIncoming(arr); 
    };
  </script>
</body>
</html>

